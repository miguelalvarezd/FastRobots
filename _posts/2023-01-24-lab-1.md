---
layout: post
title:  "Lab 1 (in progress...)"
author: miguel
#categories: [ Jekyll, tutorial ]
#tags: [red, yellow]
image: assets/images/lab1.jpg
description: "The objective of Lab 1 is to set up the Artemis board, test different programs, and become familiar with the bluetooth connection and commands."
featured: true
#rating: 4.5
---
The objective of Lab 1 is to set up the Artemis board, test different programs, and become familiar with the bluetooth connection and commands.

## PART 1

### Prelab

The prelab for Part 1 consists on installing the Arduino IDE, as well as the Artemis board support software. After installing it, we can proceed to the Part 1 tasks.

<img src="{{ site.baseurl }}/assets/images/lab1/arduino_ide.png" alt="Arduino IDE and Artemis board software.">

### Tasks
After installing the necessary software, the next tasks involve testing different components of the board, with the code from different examples built in with the IDE.

#### 1. LED Blink
The purpose of this first task is to learn how to connect the Artemis board to the computer. If everything works properly, a blue LED will turn ON for 1 second, and then turn OFF for another seconds, as shown in the following video.

<iframe width="640" height="360" frameborder="0" allowfullscreen
src="https://www.youtube.com/embed/DbYCCSf4rew">
</iframe>

#### 2. Serial Input/Output

This program tests the Serial Monitor. First, the Artemis board will display a count from 0 to 9. After that, the monitor will display everything that gets typed in, as shown in the video.

<iframe width="640" height="360" frameborder="0" allowfullscreen
src="https://www.youtube.com/embed/7E5yPQlBA0Q">
</iframe>

#### 3. Analog reading - Temperature sensor
This section tests the temperature sensor of the Artemis. When heat is applied to the chip, the temperature recorded increases, as can be seen on the second column of the results displayed in the serial monitor. The opposite happens when the chip is cooled.

<iframe width="640" height="360" frameborder="0" allowfullscreen
src="https://www.youtube.com/embed/COTvo0-jLdQ">
</iframe>

#### 4. Microphone test
Last but not least, the board can determine the frequency of the sound thanks to an integrated microphone. I used a <a href="https://www.youtube.com/watch?v=H-iCZElJ8m0" target="_blank">YouTube video</a> that sweeps across a wide range of frequencies. The Artemis board is able to determine frequencies from approximately 90Hz all the way up to 20kHz (the highest frequency of the video), according to my test.

<iframe width="640" height="360" frameborder="0" allowfullscreen
src="https://www.youtube.com/embed/SNBroP2JBns">
</iframe>


### Conclusion
After connecting the Artemis to the computer, testing various of its components, and ensuring that they work, we can proceed to the next part, where we will connect the Artemis to the computer via Bluetooth (BLE). With BLE we will be able to send commands and receive data from the Artemis wirelessly.

## PART 2

### Prelab

The prelab for Part 2 consists of setting up the computer and the Artemis in order to be able to receive and send data through BLE. In order to communicate via BLE with the Artemis, we will use Python with Jupyter notebooks. Additionally, we need to create a virtual environment for this project, in order to isolate it from the rest of the computer OS. Python can be installed from <a href="hhttps://www.python.org/downloads/" target="_blank">their website</a>. 
After this process is finished, we need to set up the virtual environment:
```
py -m pip install --user virtualenv
```
Next, we need to create the virtual environment inside the project directory:
```
py -m venv FastRobots_ble
```
The virtual environment can be activated using the following command inside the project directory:
```
source FastRobots_ble/bin/activate
```
To desactivate it, we just need to run `deactivate`. With the virtual environment active, the last step is to install the necessary Python packages:
```
pip install numpy pyyaml colorama nest_asyncio bleak jupyterlab
```
Now, the setup is finished. Whenever we want to run our code, we will first need to activate the virtual environment, and then start Jupyter notebooks by running:
```
jupyter lab
```

### Configuration

In order for the Artemis board to communicate only with our computer, we need to determine a few parameters. First, the ArduinoBLE library should be installed in the IDE (`Tools > Manage Libraries...`). Now, we are almost ready to start communications. This lab comes with a codebase, which contains all the code needed to perform this tasks. The codebase is divided into a Python part, and an Arduino part. The main files are `demo.ipynb`, wich contains the Python code that will run on the computer, and `ble_arduino.ino`, which will be executed in the Artemis. 

When we first run `ble_arduino.ino`, the Serial Monitor will print its MAC address. This is the address the Artemis uses to communicate via Bluetooth. Now, we need to change the MAC address included in the file `connection.yaml`, in the Python codebase, with the address displayed by the Artemis. 

<img src="{{ site.baseurl }}/assets/images/lab1/mac_address.png" alt="MAC address of my Artemis.">

Additionally, we need to create a new UUID (these are Universally Unique Identifiers that defferentiate the data that our Artemis sends from other boards) and replace the BLEService UUID value both in the `connection.yaml` file, as well as in the `ble_arduino.ino` file, so that they match. In order to create a new UUID we can run the following command in Jupyter:
```
from uuid import uuid4
uuid4()
```
The files `connection.yaml` and `ble_arduino.ino` will look as follows, respectively. Note how the BLEService UUID and the MAC address match in both files.

|<img src="{{ site.baseurl }}/assets/images/lab1/connection_yaml.png" alt="connection.yaml file."> | <img src="{{ site.baseurl }}/assets/images/lab1/ble_arduino.png" alt="ble_arduino.ino file.">|

Last, but not least, while trying to connect my computer to the Artemis via Bluetooth I faced some problems. The solutions were simple:

1. First, make sure that the Bluetooth setting is turned ON in my computer (otherwise it won't work).
2. Next, as I'm running Windows 11, in the `base_ble.py` file, change line 53 from `if OS_PLATFORM == "Windows" or OS_PLATFORM == "Linux":` to `if True:`.

After applying these chages my problems were solved, and my computer could connect to the Artemis.

### Codebase

Before getting into the Tasks, let's go through some basic functions of the Codebase that will be used later on.

1. The Artemis has a unique MAC address, as well a UUID, used to communicate with the computer.
2. The data sent over Bluetooth are BLExCharacteristic. In general, we will use BLECStringCharacteristic, which sends and receives strings.
3. The functions that we will use are included in the `ble.py` file. The most important ones are:
- `connect()` and `disconnect()`, used to establish Bluetooth connection with the Artemis;
- `send_command(cmd_type, data)`, used to send a command to the board and some type of data;
- `receive_string(uuid)`, used to receive a string from our board;
- `start_notify(uuid, notification_handler)`, used to activate notifications, as will be explained later on;
- and `bytearray_to_string(byte_array)`, used to convert the data received into a string.
4. All the commands used have to be stored in `cmd_types.py`, with propper enumeration; as well as in `enum CommandTypes
{}` in the `ble_arduino.ino` file. 

Now it's time to run the code in `demo.ipynb` to make sure that everything worked properly, and continued with the lab tasks.

<iframe width="640" height="360" frameborder="0" allowfullscreen
src="https://www.youtube.com/embed/t2OiPGx1gzY">
</iframe>

### Tasks

The following tasks will make sure that we are able to send and receive messages via Bluetooth, and that we understand the protocol.

#### 1. ECHO command
This first task is simple. We have to send an `ECHO` command to the Artemis, and receive the string on the computer. This command is already included in the Artemis codebase, but does nothing; so we need to modify it. Now, whenever the board receives that command, it will send back a string that says `Robot says -> [the string sent to the board] :)`. It will also print this message on the Serial Monitor. In order to send commands and receive strings, we will use the functions already mentioned in point 3 of the Codebase. When sending the command, we include whatever text we want echoed in the `data` argument. Later, we will print the string:

<img src="{{ site.baseurl }}/assets/images/lab1/echo.png" alt="connection.yaml file.">

#### 2. GET_TIME_MILLIS command
The next task involves creating a new command, `GET_TIME_MILLIS`, that will obtain the time from the Artemis, send back a string with the format `T:[time]`. The time in the Artemis can be obtained with the function `millis()`. For simplicity, I defined the time as a float (`(float)millis()`), and divided it by 1000, in order to obtain seconds. This command doesn't need any additional input, so the argument `data` is empty.

<img src="{{ site.baseurl }}/assets/images/lab1/get_time_millis.png" alt="connection.yaml file.">

#### 3. Notification Handler

#### 4. GET_TIME_MILLIS_LOOP command

#### 5. SEND_TIME_DATA command

#### 6. GET_TEMP_READINGS command

#### 7. Differences between Methods

### Conclusion

### In progress...
