---
layout: post
title:  "Lab 9 - Mapping"
author: miguel
#categories: [ Jekyll, tutorial ]
#tags: [red, yellow]
image: assets/images/lab9.png
description: "The objective of Lab 9 is to map a static room with the robot."
featured: false
hidden: true
#rating: 4.5
---
The objective of Lab 9 is to map a static room with the robot.

### Prelab

The prelab of this lab consists of reviewing the lecture on transformation matrices, as they will be useful later on. 

### Tasks

The goal of this lab is to map certain room. To do this, the robot will rotate on its axis in small angles, and obtain the distance to the wall at that angle. The way I chose to do this was with Orientation Control, as it has proven to be an efective method in previous labs. The room the robot will map is shown below. The robot will be placed at every point marked in the floor and get readings from there.

|<img class= "img_post" src="{{ site.baseurl }}/assets/images/lab9/room_front.jpg" alt="Room, front view.">|<img class= "img_post" src="{{ site.baseurl }}/assets/images/lab9/room_back.jpg" alt="Room, back view.">|


#### 1. Orientation Control

The first step of the lab is to set up the Orientation Control, so that the robot reads a distance every certain angle. The Controller from <a href="https://miguelalvarezd.github.io/FastRobots/lab-6/" target="_blank">Lab 6</a> was reused, with some modifications.

- Aside from Kp, Ki and Kd, the number of readings (`nReadings`) and the angle between each reading (`angle_to_turn`) were also set via Bluetooth.

- Whenever the error is 0 for some loop cycles, the controller will reset the angle back to 0 (therefore reducing the drift), read the distance to the wall, and perform a new turn.

```
if(mapp.last_n_error_0 >= 5){
  //Read new values from ToF...

  //Save angle and values of distance...

  mapp.j++; //Update counter of readings

  //Now, reset the angle to 0. The Set Point is the same as angle_to_turn, so the robot will turn again
  mapp.yaw = 0;
}
```

- Once we have done `nReadings`, stop the test.

```
if(mapp.j > mapp.nReadings){
  mapp.run_test = false;
  mapp.pid = 0;
  brake();
  Serial.println("Test ended. Brake");
}
```

With this controller we can make the robot turn on-axis, and read the distance at every turn, as show in the video below. To have more readings, and therefore create a more reliable map, both ToF sensors were used (One points to the front, and the other is positioned 90 degrees to the right. See <a href="https://miguelalvarezd.github.io/FastRobots/lab-4/#:~:text=was%20broken.%20The-,new%20layout,-of%20the%20robot" target="_blank">layout from Lab 4</a>).

<iframe width="640" height="360" frameborder="0" allowfullscreen
src="https://www.youtube.com/embed/jJ3lj4UVngA">
</iframe>

#### 2. Map Readings